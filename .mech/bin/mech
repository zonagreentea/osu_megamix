#!/usr/bin/env zsh
set -euo pipefail

ROOT="${IMAGINATION_ROOT:-$PWD/.mech}"
HUB="${OSU_MEGAMIX_DIR:-$HOME/osu_megamix}"
BALL_DIR="${BALL_DIR:-$HOME/Work/ball}"

CMD="${1:-}"; shift || true
die(){ echo "mech: $*" >&2; exit 1; }

case "$CMD" in
  status)
    echo "MECH_ROOT=$ROOT"
    echo "HUB=$HUB"
    echo "BALL_DIR=$BALL_DIR"
    ;;
  megamix)
    cd "$HUB" || die "missing hub at $HUB"
    [[ -x ./mixrun ]] || die "missing ./mixrun"
    exec ./mixrun "$@"
    ;;
  megamix-bg)
    cd "$HUB" || die "missing hub at $HUB"
    exec ./mixrun --background "$@"
    ;;
  megamix-stop)
    cd "$HUB" || die "missing hub at $HUB"
    exec ./mixrun --stop "$@"
    ;;
  ball)
    cd "$BALL_DIR" || die "missing ball at $BALL_DIR"
    if [[ -x ./RUN ]]; then exec ./RUN "$@"; fi
    if [[ -x ./ball ]]; then exec ./ball "$@"; fi
    echo "mech: ball present, no launcher found"
    ;;
  ball-push)
    cd "$BALL_DIR" || die "missing ball at $BALL_DIR"
    git status
    git add -A
    git commit -m "ball" || true
    BALL_PUSH_OK=1 git push
    ;;
  *)
    cat <<'HELP'
mech:
  mech status
  mech megamix | megamix-bg | megamix-stop
  mech ball
  mech ball-push   (guarded)
HELP
    exit 2
    ;;
esac
