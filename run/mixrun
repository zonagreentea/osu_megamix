#!/bin/sh
set -eu

FILE="${1:-}"
[ -n "$FILE" ] || { echo "usage: ./run/mixrun <file.mix>" >&2; exit 1; }

FILE="${FILE/#\~/$HOME}"
[ -e "$FILE" ] || { echo "mixrun: file not found: $FILE" >&2; exit 1; }

FILE="$(cd "$(dirname "$FILE")" && pwd)/$(basename "$FILE")"

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
cd "$ROOT"

PORT="${PORT:-8000}"
while lsof -nP -iTCP:"$PORT" -sTCP:LISTEN >/dev/null 2>&1; do
  PORT=$((PORT+1))
done

ENCODED="$(printf '%s' "$FILE" | python3 - <<'PY'
import sys, urllib.parse
print(urllib.parse.quote(sys.stdin.read()))
PY
)"

URL="http://127.0.0.1:$PORT/index.html?mix=$ENCODED"

echo "[mixrun] $FILE"
echo "[mixrun] $URL"

python3 -m http.server "$PORT" >/dev/null 2>&1 &
sleep 0.4
open "$URL"
wait
