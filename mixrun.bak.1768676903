#!/usr/bin/env zsh
set -euo pipefail

HERE="${0:A:h}"

pick_mix() {
  find "$HERE" -type f -name '*.mix' 2>/dev/null | LC_ALL=C sort | head -n 1
}

heartbeat_audio() {
  local state="$HERE/.playful-cloud"
  mkdir -p "$state"
  local wav="$state/heartbeat.wav"

  if command -v python3 >/dev/null 2>&1; then
    python3 - <<'PY' "$wav"
import math, struct, wave, sys
p=sys.argv[1]
sr=44100; dur=1.0; f=220.0; a=0.2
n=int(sr*dur)
with wave.open(p,'w') as w:
    w.setnchannels(1); w.setsampwidth(2); w.setframerate(sr)
    for i in range(n):
        s=int(a*32767*math.sin(2*math.pi*f*i/sr))
        w.writeframes(struct.pack('<h', s))
PY
  fi

  if [[ -f "$wav" ]] && command -v afplay >/dev/null 2>&1; then
    ( while true; do afplay "$wav"; done ) &!; disown
  elif [[ -f "$wav" ]] && command -v ffplay >/dev/null 2>&1; then
    ( while true; do ffplay -nodisp -autoexit -loglevel quiet "$wav"; done ) &!; disown
  fi
}

# no-arg boot
if [[ $# -lt 1 || "${1:-}" != *.mix ]]; then
  MIX="$(pick_mix || true)"
  if [[ -n "${MIX:-}" ]]; then
    set -- "$MIX" "$@"
  else
    heartbeat_audio || true
    echo "mixrun: no .mix found, audio heartbeat active"
  fi
fi
set -euo pipefail

FILE="${1:?usage: ./mixrun <file.mix>}"
case "$FILE" in "~"*) FILE="$HOME${FILE#\~}" ;; esac
[ -e "$FILE" ] || { echo "mixrun: file not found: $FILE" >&2; exit 1; }
FILE="$(cd "$(dirname "$FILE")" && pwd)/$(basename "$FILE")"

# resolve symlinks so ./mixrun -> run/mixrun still finds repo root
SCRIPT="$0"
while [ -L "$SCRIPT" ]; do
  LINK="$(readlink "$SCRIPT")"
  case "$LINK" in
    /*) SCRIPT="$LINK" ;;
    *)  SCRIPT="$(cd "$(dirname "$SCRIPT")" && pwd)/$LINK" ;;
  esac
done
SCRIPT_DIR="$(cd "$(dirname "$SCRIPT")" && pwd)"
ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$ROOT"

PORT="${PORT:-8000}"
while lsof -nP -iTCP:"$PORT" -sTCP:LISTEN >/dev/null 2>&1; do PORT=$((PORT+1)); done

# URL-encode full path (escape / as %2F)
ENCODED="$(python3 - <<'PY' "$FILE"
import urllib.parse, sys
print(urllib.parse.quote(sys.argv[1], safe=""))
PY
)"
URL="http://127.0.0.1:$PORT/index.html?mix=$ENCODED"

# redact HOME in printed path (don’t leak username)
SAFE_FILE="$FILE"
case "$SAFE_FILE" in "$HOME"/*) SAFE_FILE="<HOME>${SAFE_FILE#$HOME}" ;; esac

echo "[mixrun] cwd=$(pwd)"
echo "[mixrun] $SAFE_FILE"
echo "[mixrun] $URL"
echo "[mixrun] Ctrl-C to stop"

python3 -u -m http.server "$PORT" &
SRV_PID=$!
trap 'kill "$SRV_PID" 2>/dev/null || true' INT TERM EXIT

# wait until server responds (prevents race)
for _ in $(seq 1 100); do
  curl -fs "http://127.0.0.1:$PORT/index.html" >/dev/null 2>&1 && break
  sleep 0.05
done

open "$URL"

# keep launcher alive (don’t exit and kill server)
while kill -0 "$SRV_PID" 2>/dev/null; do sleep 1; done
