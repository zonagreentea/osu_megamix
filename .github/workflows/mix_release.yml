name: mix-release

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: mix-release
  cancel-in-progress: true

env:
  TAG: osu-megamix-mix
  TITLE: osu!megamix.mix

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build (repo packager)
        shell: bash
        run: |
          set -euo pipefail
          if [ -x tools/release_full.zsh ]; then
            zsh -f tools/release_full.zsh
          elif [ -x full_megamix_pkg.sh ]; then
            bash ./full_megamix_pkg.sh
          else
            echo "No packager found (tools/release_full.zsh or full_megamix_pkg.sh)"; exit 1
          fi

      - name: Prepare artifacts
        shell: bash
        run: |
          set -euo pipefail
          test -d dist/osu\!megamix.mix || { echo "dist/osu!megamix.mix missing"; ls -lah dist || true; exit 1; }

          # universal .mix payload
          tar -czf dist/osu_megamix_universal_${{ runner.os }}.tar.gz -C dist osu\!megamix.mix

          # include platform archives if packager created them
          ls -lah dist || true

      - name: Upload build artifacts (for release job)
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ runner.os }}
          path: |
            dist/osu_megamix_universal_*.tar.gz
            dist/osu_megamix_mac.zip
            dist/osu_megamix_windows.zip
            dist/osu_megamix_linux.tar.gz

  release:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Install GitHub CLI
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: out

      - name: Create/update stable release + upload assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          # Create release if missing (stable tag)
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release exists: $TAG"
          else
            gh release create "$TAG" --title "$TITLE" --notes "auto: main -> mix release"
          fi

          # Upload everything we downloaded (clobber replaces)
          find out -type f -maxdepth 3 -print -exec gh release upload "$TAG" "{}" --clobber \;

          # Print final asset list
          gh release view "$TAG" --json assets -q ".assets[].name"
